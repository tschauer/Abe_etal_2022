




##################################################################################################################################
##################################################################################################################################



library(ShortRead)
library(rtracklayer)
library(HelpersforChIPSeq)


args = commandArgs(trailingOnly=TRUE)



##################################################################################################################################
##################################################################################################################################

######################################################   Annotation    ########################################################## 




load(grep("ranges_genebody", args, value = TRUE))
load(grep("ranges_TSS", args, value = TRUE))
load(grep("ranges_TTS", args, value = TRUE))
load(grep("ranges_GB5", args, value = TRUE))
load(grep("ranges_bins", args, value = TRUE))
load(grep("ranges_b10", args, value = TRUE))
load(grep("ranges_exons", args, value = TRUE))
load(grep("ranges_introns", args, value = TRUE))
load(grep("ranges_intergenic", args, value = TRUE))




my_file_path <- grep(".bam$", args, value = TRUE)

my_ID <-  gsub(".bam|.*\\/", "", my_file_path)



##################################################################################################################################
##################################################################################################################################















##################################################################################################################################
##################################################################################################################################

#################################################       Genebody Counts      ##################################################### 



my_name <- paste("genebody", my_ID, sep = ".")


my_genebody_counts <- countReadsOverGrangesInBAM(my_ranges = my_genebody_ranges,
                                                 bam_file = my_file_path,
                                                 bam_type = "PAIRED",
                                                 frag.unique = "bothEND",
                                                 subsampling = FALSE)

assign(my_name, my_genebody_counts)
save(list = my_name, file = grep("counts/genebody", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################

















##################################################################################################################################
##################################################################################################################################

#################################################         Bin Counts         ##################################################### 



my_name <- paste("bins", my_ID, sep = ".")


my_bin_counts <- countReadsOverGrangesInBAM(my_ranges = my_bins,
                                            bam_file = my_file_path,
                                            bam_type = "PAIRED",
                                            frag.unique = "bothEND",
                                            subsampling = FALSE)

assign(my_name, my_bin_counts)
save(list = my_name, file = grep("counts/bins", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################











##################################################################################################################################
##################################################################################################################################

#################################################      10 kb bin Counts       ##################################################### 



my_name <- paste("b10", my_ID, sep = ".")


my_b10_counts <- countReadsOverGrangesInBAM(my_ranges = my_b10_ranges,
                                            bam_file = my_file_path,
                                            bam_type = "PAIRED",
                                            frag.unique = "bothEND",
                                            subsampling = FALSE)

assign(my_name, my_b10_counts)
save(list = my_name, file = grep("counts/b10", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################
















##################################################################################################################################
##################################################################################################################################

#################################################         TSS Counts         ##################################################### 



my_name <- paste("TSS", my_ID, sep = ".")


my_TSS_counts <- countReadsOverGrangesInBAM(my_ranges = my_TSS_ranges,
                                            bam_file = my_file_path,
                                            bam_type = "PAIRED",
                                            frag.unique = "bothEND",
                                            subsampling = FALSE)

assign(my_name, my_TSS_counts)
save(list = my_name, file = grep("counts/TSS", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################


















##################################################################################################################################
##################################################################################################################################

#################################################         TTS Counts         ##################################################### 



my_name <- paste("TTS", my_ID, sep = ".")


my_TTS_counts <- countReadsOverGrangesInBAM(my_ranges = my_TTS_ranges,
                                            bam_file = my_file_path,
                                            bam_type = "PAIRED",
                                            frag.unique = "bothEND",
                                            subsampling = FALSE)

assign(my_name, my_TTS_counts)
save(list = my_name, file = grep("counts/TTS", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################

















##################################################################################################################################
##################################################################################################################################

#################################################         GB5 Counts         ##################################################### 



my_name <- paste("GB5", my_ID, sep = ".")


my_GB5_counts <- countReadsOverGrangesInBAM(my_ranges = my_GB5_ranges,
                                            bam_file = my_file_path,
                                            bam_type = "PAIRED",
                                            frag.unique = "bothEND",
                                            subsampling = FALSE)

assign(my_name, my_GB5_counts)
save(list = my_name, file = grep("counts/GB5", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################














##################################################################################################################################
##################################################################################################################################

#################################################         exons Counts         ##################################################### 



my_name <- paste("exons", my_ID, sep = ".")


my_exon_counts <- countReadsOverGrangesInBAM(my_ranges = my_exon_ranges,
                                            bam_file = my_file_path,
                                            bam_type = "PAIRED",
                                            frag.unique = "bothEND",
                                            subsampling = FALSE)

assign(my_name, my_exon_counts)
save(list = my_name, file = grep("counts/exons", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################















##################################################################################################################################
##################################################################################################################################

#################################################        introns Counts        ##################################################### 



my_name <- paste("introns", my_ID, sep = ".")


my_intron_counts <- countReadsOverGrangesInBAM(my_ranges = my_intron_ranges,
                                            bam_file = my_file_path,
                                            bam_type = "PAIRED",
                                            frag.unique = "bothEND",
                                            subsampling = FALSE)

assign(my_name, my_intron_counts)
save(list = my_name, file = grep("counts/introns", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################




















##################################################################################################################################
##################################################################################################################################

#################################################   intergenic Counts        ##################################################### 



my_name <- paste("intergenic", my_ID, sep = ".")


my_intergenic_counts <- countReadsOverGrangesInBAM(my_ranges = my_intergenic_ranges,
                                            bam_file = my_file_path,
                                            bam_type = "PAIRED",
                                            frag.unique = "bothEND",
                                            subsampling = FALSE)

assign(my_name, my_intergenic_counts)
save(list = my_name, file = grep("counts/intergenic", args, value = TRUE))



##################################################################################################################################
##################################################################################################################################

















##################################################################################################################################
##################################################################################################################################

