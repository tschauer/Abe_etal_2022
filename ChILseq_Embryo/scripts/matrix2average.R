






##################################################################################################################################
##################################################################################################################################




library(DESeq2)
library(ShortRead)
library(rtracklayer)
library(HelpersforDESeq2)
library(HelpersforChIPSeq)
library(topGO)
library(pheatmap)
library(sva)

library(multcomp)
library(gplots)

library(reshape2)
library(ggplot2)
library(ggpubr)


library(org.Mm.eg.db)


##################################################################################################################################
##################################################################################################################################




args = commandArgs(trailingOnly=TRUE)



input_table <- grep("SampleTable", args, value = TRUE)

output_files <- grep("matrix_ave", args, value = TRUE)


my_group <- unique(gsub(".*\\/", "", gsub("_T.*", "",output_files)))

stopifnot(length(my_group) == 1)

matrix_files <- grep(paste0(my_group, "_[1-9]_T.*matrix.rds"), args, value = TRUE)
matrix_files <- matrix_files[order(matrix_files)]


stopifnot(length(matrix_files) == 6)



##################################################################################################################################
##################################################################################################################################










##################################################################################################################################
##################################################################################################################################

######################################################     Read Mats    ########################################################## 


i=1

for(i in seq_along(matrix_files)){
        
        my_name <- gsub(".*matrix/|_matrix.*","",matrix_files[i])
        my_site <- gsub(".*_","",my_name)
        my_name <- paste0(my_site,".",gsub(paste0("_",my_site),"", my_name))
        
        
        my_mat <- readRDS(matrix_files[i])
        
        assign(my_name, my_mat)
        
        rm(list = "my_mat")
}


my_mats <- ls(pattern = paste0("T[S,T]S.", my_group))


for(i in seq_along(my_mats)){
        
        stopifnot(identical(rownames(get(my_mats[1])), rownames(get(my_mats[i]))))    
}



##################################################################################################################################
##################################################################################################################################













##################################################################################################################################
##################################################################################################################################

###################################################       Average Mats      ###################################################### 


my_sites <- unique(gsub("\\..*","",my_mats))

stopifnot(length(my_sites) == 2)

for(my_site in (my_sites)){
        
        my_sample_mats <- grep(my_site, my_mats, value = TRUE)
        
        stopifnot(length(my_sample_mats) == 3)
        stopifnot(length(unique(gsub("_[1-9]","",my_sample_mats))) == 1)
        
        mat.ave <- averageMats(my_mats = my_sample_mats)
        
        saveRDS(mat.ave, file = grep(my_site, output_files, value = TRUE))
        
}

##################################################################################################################################
##################################################################################################################################









##################################################################################################################################
##################################################################################################################################
